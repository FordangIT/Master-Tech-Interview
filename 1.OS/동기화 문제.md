## 동기화 문제

**동기화:**한정적인 시스템 자원에 여러 스레드가 동시에 접근할 때 발생하는 문제를 방지하기 위해서, 여러 스레드에게 하나의 자원에 대한 처리 권한을 부여 하거나 순서를 조정하는 기법이다.

### 스레드 동기화

**1. 실행 순서의 동기화** : 스레드의 실행 순서를 정의하고, 반드시 그 순서를 따르도록 하는 것.
**2. 메모리 접근에 대한 동기화**

- 메모리 접근 시 동시 접근을 막는 것.
- 실행 순서보다는 한 순간에 하나의 스레드만 해당 자원에 접근하도록 하는 것이 중요.

### 동기화 기법

**1. 유저 모드의 동기화**

- 커널의 도움없이 이루어지는 동기화 기법
- 성능상의 이점이 있으나 기능상의 제한이 있다.
- ex) 임계 구역 기반의 동기화, 인터락 함수 기반의 동기화.

#### 1) 임계 구역 기반의 동기화

- 열쇠를 얻은 프로세스만 임계 구역에 들어갈 수 있다. 즉, 한번에 하나의 스레드만이 접근 가능하다.
- 임계 구역 진입을 위해 `critical section object`를 획득한다.
- 다른 스레드가 열쇠를 가지고 있을 경우, 반환될 때까지 해당 스레드는 blocking 상태가 된다. 열쇠가 반환되면 blocking 상태에서 벗어나 열쇠를 얻고 임계 구역에 접근할 수 있다.

#### 2) 인터락 함수 기반의 동기화 (Interlocked Functions)

- 함수 내부적으로 한 순간에 하나의 스레드만 실행되도록 동기화한다.
- 임계 구역 기반의 동기화도 내부적으로 인터락 함수를 기반으로 구현된다.
- 유저 모드에서 동작하므로 속도가 빠르다.

**2. 커널 모드의 동기화**

- 커널에서 제공하는 동기화 기능을 이용하는 방법.
- 커널 모드로의 전환이 필요해 성능 저하가 있을 수 있으나 다양한 기능을 활용할 수 있다.
- ex) 세마포어, 뮤텍스, 모니터 등등.

#### 1) 세마포어(Semaphore)

- 공유된 자원에 여러 프로세스나 스레드가 동시에 접근하는 것을 막는 기법.
- 동시에 접근할 수 있는 '허용 가능한 개수'를 가지는 카운터 역할을 한다. 이 카운터는 공유 자원에 접근할 수 있는 스레드 또는 프로세스의 수를 나타낸다.
- ex) 화장실
  : 세마포어는 여러 개의 열쇠로 비유할 수 있다. 화장실 칸이 4개 있고, 열쇠가 4개라면, 4명까지는 대기없이 사용할 수 있다. 이후에는 대기를 해야 한다.
- Semaphore Counter 개수에 따라 두가지로 나뉜다.
  - 1개: Binary Semaphore(뮤텍스와 유사)
  - 2개이상: Counting Semaphore
- Semaphore는 소유할 수 없다.
  - 세마포어를 소유하지 않은 스레드가 세마포어를 해제할 수 있는 문제가 발생할 수 있다.

세마포어는 운영체제나 다중 스레드 환경에서 중요한 동기화 도구로 사용된다. 세마포어를 통해 자원 접근을 제어함으로써 교착 상태(데드락)와 같은 문제를 예방할 수 있다. Binary Semaphore는 주로 상호 배제를 위해 사용되며, Counting Semaphore는 제한된 자원에 대한 접근을 관리하는데 유용하다.

#### 2) 뮤텍스

: 뮤텍스()는 여러 프로세스나 스레드가 동시에 공유 자원에 접근하는 것을 방지하기 위해 사용되는 동기화 매커니즘이다. 뮤텍스를 이용하면 데이터 일관성을 유지하고 경합 상태를 피할 수 있다.

**1. 공유 자원 접근 제어**

- 여러 프로세스나 스레드가 공유 자원에 동시 접근하지 못하게 막는다.
- 자원에 대한 동시 접근을 제어하며 데이터 일관성을 유지한다.

**2. 임계 구역 보호**

- 임계 구역은 동시에 하나의 프로세스나 스레드만 접근할 수 있는 코드 영역이다.
- 뮤텍스는 임계 구역을 가진 스레드들이 서로 겹치지 않고 단독으로 실행되도록 보장한다.

**3. 단일 접근 원칙**

- 뮤텍스 객체는 두 스레드가 사용할 수 없다.
- 오직 하나의 스레드만 뮤텍스를 획득(lock)하고, 나머지 스레드는 뮤텍스가 해제(unlock)될 때까지 대기한다.

**4. Locking 매커니즘**

- 뮤텍스는 잠금과 해제 매커니즘을 통해 공유 자원에 대한 접근을 조율한다.
- 스레드는 자원에 접근하기 전에 뮤텍스를 획득하고, 자원 사용 후에는 뮤텍스를 해제한다.

**5. Lock 소유권**

- 뮤텍스는 소유권이 있으며, 뮤텍스를 획득한 스레드만이 공유자원에 접근할 수 있다.
- 또한, 뮤텍스를 획득한 스레드만이 뮤텍스를 해제할 수 있다.

**6. 단일 열쇠 원칙**

- 뮤텍스는 항상 하나의 열쇠만 가질 수 있다.
- 여러 스레드가 하나의 뮤텍스를 공유하는 경우, 동시에 하나의 스레드만이 뮤텍스를 획득할 수 있다.

- 공유된 자원의 데이터를 여러 프로세스, 스레드가 접근하는 것을 막는다.
- 임계 구역을 가진 스레드들의 Running time이 서로 겹치지 않게 가각단독으로 실행하게 하는 기술이다.
- 뮤텍스 객체를 두 스레드가 동시에 사용할 수 없다.
- 일종의 Locking 매커니즘으로 공유 자원에 대한 접근을 조율하기 위해 locking과 unlocking을 사용한다.
- Lock에 대한 소유권이 있으며 Lock을 가지고 있을 경우에만 공유 자원에 접근할 수 있고, Lock을 가진 사람만 반납할 수 있따.
- 뮤텍스는 무조건 1개의 열쇠만 가질 수 있다.

#### 3) 모니터

- Mutex(Lock)와 Condition Variables를 포함하는 동기화 매커니즘
- 병렬 프로그래밍에서 중요한 역할을 한다.
- 모니터는 한번에 하나의 스레드만 모니터 내부의 임계 구역에 접근할 수 있도록 하여 경쟁 조건을 방지한다. 이를 통해 공유 자원의 일관성과 무결성을 유지할 수 있다.

* **Condition Variables**

- 특정 조건이 충족될 때까지 스레드가 대기하도록 하는 메커니즘이다. 모니터는 하나 이상의 조건 변수를 포함할 수 있다.
- 스레드는 조건 변수를 통해 wait하고, 다른 스레드가 조건을 만족시키면 신호(signal) 또는 브로드캐스트(broadcast)를 통해 대기 중인 스레드에게 알릴 수 있다.
- 이를 통해 스레드 간의 효율적인 통신과 동기화 가능하다.

**비교)**

- 뮤텍스와 모니터는 상호배제를 함으로써 임계 구역에 하나의 thread만 들어갈 수 있다.
- 반면, 세마포어는 하나의 쓰레드 혹은 여러개의 쓰레드도 들어갈 수 있다.

**Q. 임계영역이란?(Critical Section)**

- 두 개 이상의 스레드가 동시에 접근해서는 안되는 공유 자원에 접근하는 코드의 일부를 의미한다. 임계 영역에서 동기화를 제대로 하지 못하면 치명적인 문제 발생할 수 있다. 이러한 문제를 해결하기 위해서는 3가지 필수 조건을 만족해야 한다.
  - 1. 상호배제 (Mutual exclusion)
       : 하나의 프로세스가 공유 자원에 접근하여 임계 구역 코드를 수행하고 있을 때, 다른 프로세스들은 그 자원에 접근할 수 없도록 한다. 즉, 임계구역에는 한 번에 하나의 프로세스만 들어갈 수 있다.
    - 동시에 자원에 접근해서 발생할 수 있는 데이터 불일치 문제 방지
  - 2. 진행 (Progress)
       :임계 구역에서 실행중인 프로세스가 없을 때, 임계 구역에 진입하려는 프로세스 중 하나가 반드시 진입할 수 있어야 한다. 또한 임계 구역에 진입할 수 있는 프로세스를 결정하는 데 불필요한 지연이 없어야 한다.
    - 진행 조건을 통해 시스템 자원이 유휴 상태가 되지 않도록 하며, 임계 구역에 진입하려는 프로세스가 무한 대기 상태에 빠지지 않도록 한다.
  - 3. 한정된 대기 (Bounded Waiting)
       :어떤 프로세스가 임계 구역에 진입을 요청한 후부터 받아들여질 때까지, 다른 프로세스들이 임계 구역에 진입하는 횟수는 제한되어야 한다. 즉, 한 프로세스가 임게 구역에 진입하려고 무한정 기다리는 일이 없어야 한다.
    - 한정된 대기 조건을 통해 프로세스가 지나치게 오래 기다리지 않도록 보장한다. 이는 시스템의 공정성을 유지하는데 중요하다.

**요약**: 임계 영역은 여러 스레드가 공유 자원에 동시에 접근하여 발생할 수 있는 문제를 방지하기 위해 필요한 부분이다. 이를 해결하기 위해서는 상호 배제, 진행, 한정된 대기의 세 가지 조건을 만족해야 한다. 이러한 조건들을 통해 시스템의 일관성과 무결성을 유지할 수 있으며, 공정하고 효율적인 자원 관리를 할 수 있다.

**Q. 뮤텍스와 모니터의 차이는?**

- **사용범위**: 뮤텍스는 여러 프로세스 간에도 사용될 수 있지만, 모니터는 하나의 프로세스 내에서만 사용된다.
- **제공 주체**: 뮤텍스는 운영체제 커널에 의해 제공되어 무겁고 느린 반면, 모니터는 프레임워크나 라이브러리에서 제공되어 가볍고 빠르다.
- **동기화 대상**: 뮤텍스는 주로 프로세스 간 또는 스레드 간 동기화에 사용되며, 모니터는 주로 스레드 간 동기화에 사용된다.
- **복잡도 및 성능**: 뮤텍스는 커널 모드에서 실행되기 때문에 더 무겁고 성능 저하가 발생할 수 있지만, 모니터는 소프트웨어 레벨에서 관리되어 비교적 가볍고 빠르다.

**Q.세마포어와 모니터의 차이는?**

- **제공 방식**: 세마포어는 프로그래머가 명시적으로 생성하고 관리해야 하지만, 모니터는 Java와 같은 객체 지향 언어에서 기본적으로 제공된다.
- **카운터 관리**: 세마포어는 카운터 값을 직접 관리해야 하며, 이를 통해 복잡한 동기화 로직을 구현할 수 있다. 반면, 모니터는 이러한 세부 사항이 캡슐화되어 있어 개발자가 직접 관리할 필요가 없다.
- **사용 편의성**: 모니터는 `synchronized`, `wait()`, `notify()` 등의 키워드를 사용하여 동기화 작업을 간편하게 수행할 수 있다. 세마포어는 좀 더 낮은 수준의 제어가 가능하지만, 그만큼 사용이 번거로울 수 있다.
- **언어 지원**: 세마포어는 대부분의 프로그래밍 언어에서 지원되며, 특히 C와 같은 저수준 언어에서 자주 사용된다. 모니터는 Java와 같은 고급 객체 지향 언어에서 기본적으로 제공된다.

**Q. 세마포어와 뮤텍스의 차이는?**

- 뮤텍스는 한 스레드나 프로세스에 의해 소유될 수 있는 키를 기반으로 한 상호 배제 기법이다.
- 세마포어는 현재 공유 자원에 접근할 수 있는 스레드나 프로세스의 수를 나타내는 값을 두어 상호 배제를 달성하는 기법이다.

- **소유권**: 세마포어는 소유 개념이 없으며, 모든 스레드가 세마포어를 사용할 수 있다. 뮤텍스는 특정 스레드가 소유하며, 소유한 스레드만이 해제할 수 있다.
- **해제 조건**: 세마포어는 어떤 스레드든 해제할 수 있지만, 뮤텍스는 소유한 스레드만이 해제할 수 있다.
- **용도**: 세마포어는 여러 개의 리소스를 관리하거나 다수의 스레드가 접근할 때 사용된다. 뮤텍스는 단일 리소스에 대한 상호 배제가 필요할 때 사용된다.
- **동기화 대상**: 세마포어는 동기화 대상이 여러 개일 때 사용되고, 뮤텍스는 동기화 대상이 하나일 때 사용된다.

**한계 및 고려사항**

- **데드락** : 뮤텍스와 세마포어를 사용하더라도 데드락이 발생할 수 있다. 따라서 이들 기법을 사용할 때는 데드락을 방지하기 위한 추가적인 메커니즘이 필요할 수 있다.
- **데이터 무결성**: 기본적인 상호 배제 기법만으로는 데이터 무결성을 완벽하게 보장할 수 없다. 더 복잡ㅎ나 동기화 메커니즘과 설계를 통해 데이터 무결성을 확보해야 한다.
